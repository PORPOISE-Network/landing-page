<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="keywords"
        content="PORPOISE, Proof of Reputation, Protocol, zero knowledge proof, zkSNARK, crypto, Mina Protocol, Protokit, surveys, predictions">
    <meta name="description" content="Take a PORPOISE Survey">
    <title>PORPOISE Network</title>

    <style>
        body {
            background-color: #000;
            color: #0ff;
            /* Light blue font color */
            font-family: 'Courier New', monospace;
            text-align: center;
            margin: 0;
            padding: 0;
        }

        header {
            padding: 50px;
        }

        h1 {
            font-size: 3em;
            margin: 10px;
        }

        p {
            font-size: 1.2em;
            margin: 20px;
        }

        /* visited link */
        a[href]:visited {
            color: #00d0ff;
        }

        /* mouse over link */
        a[href]:hover {
            color: #00ddff;
        }

        /* unvisited link */
        a[href] {
            color: #0ff;
            text-decoration: none;
        }

        fieldset {
            border: 1px solid #0ff;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
            width: max-content;
            max-width: 100%;
            align-items: center;
            justify-content: center;
            display: inline;
        }

        legend {
            font-size: 18px;
            color: #0ff;
            margin-bottom: 10px;
        }

        input[type="radio"] {
            margin-right: 8px;
            appearance: none;
            /* Remove default radio button appearance */
            width: 18px;
            height: 18px;
            border: 2px solid #0ff;
            border-radius: 50%;
            /* Make it round */
            outline: none;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        /* Style the radio button when checked */
        input[type="radio"]:checked {
            background-color: #0ff;
            border-color: #0ff;
        }

        .button-28 {
            appearance: none;
            background-color: transparent;
            border: 1px solid #0ff;
            border-radius: 15px;
            box-sizing: border-box;
            color: #0ff;
            cursor: pointer;
            display: inline-block;
            font-family: Roobert, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            font-size: 16px;
            font-weight: 600;
            line-height: normal;
            margin: 0;
            min-height: 60px;
            min-width: fit-content;
            outline: none;
            padding: 16px 24px;
            text-align: center;
            text-decoration: none;
            transition: all 300ms cubic-bezier(.23, 1, 0.32, 1);
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation;
            width: 100px;
            will-change: transform;
        }

        .button-28:disabled {
            pointer-events: none;
        }

        .button-28:hover {
            color: #0ff;
            background-color: #1A1A1A;
            box-shadow: rgba(0, 0, 0, 0.25) 0 8px 15px;
            transform: translateY(-2px);
        }

        .button-28:active {
            box-shadow: none;
            transform: translateY(0);
        }

        footer {
            padding: 20px;
        }

        header img {
            width: 2.5em;
            /* Set the width to match the font size */
            height: 1em;
            /* Set the height to match the font size */
        }
    </style>

    <script>
        let prediction;
        let surveyLeafs = [];
        let paddedSurveyLeafs;
        let surveyRoot;

        const urlPrefix = 'https://porpoise.network/take-survey.html?';
        const urlEncodedLock = '%F0%9F%94%92'

        function getSurveyComponents() {

            // Get the search parameters from the URL
            //const urlParams = new URLSearchParams(window.location.search);
            const queryString = window.location.search;
            const urlParams = parseQueryString(queryString.slice(1, queryString.size));

            const numParams = Object.keys(urlParams).length;
            console.log("URL Params: ", urlParams);

            if (numParams >= 5) {
                const numOptions = numParams - 3;
                console.log("Number of options: ", numOptions);

                // Retrieve the body, deadline, and oracle content
                const dolphin = urlParams['üê¨'];
                const alarmclock = urlParams['‚è∞'];
                const oracle = urlParams['üîÆ'];

                console.log('üê¨ Dolphin:', dolphin);
                console.log('‚è∞ Deadline:', alarmclock);
                console.log('üîÆ Oracle: ', oracle);

                // check if the required parameters where supplied
                if (dolphin === null) {
                    document.getElementById('üê¨').innerHTML = "Missing üê¨ in URL.";
                    return 0;
                } else {
                    document.getElementById('üê¨').innerHTML = 'üê¨ ' + dolphin.replace(/-/g, ' ');
                    surveyLeafs.push(dolphin);
                }

                if (alarmclock === null) {
                    document.getElementById('üê¨').innerHTML = "Missing ‚è∞ in URL.";
                    return 0;
                } else {
                    document.getElementById('‚è∞').innerHTML = '‚è∞ Deadline: ' + convertUTCtoDate(alarmclock);
                    surveyLeafs.push(alarmclock);
                }

                if (oracle === null) {
                    document.getElementById('‚è∞').innerHTML = '';
                    document.getElementById('üê¨').innerHTML = "Missing üîÆ in URL.";
                    return 0;
                } else {
                    if (oracle === '0') {
                        document.getElementById('üîÆ').innerHTML = 'üîÆ Oracle Address: No oracle for this survey.';
                    } else {
                        document.getElementById('üîÆ').innerHTML = 'üîÆ Oracle Address: ' + oracle;
                    }
                    surveyLeafs.push(oracle);
                }

                // loop over the options and store in an options array
                const options = [];
                for (let i = 1; i <= numOptions; i++) {
                    let option = urlParams['üó≥' + i];
                    if (option !== null) {
                        options.push(option);
                        surveyLeafs.push(option);
                    }
                }

                // if there are not at least two options, then the survey is not valid
                if (options.length < 2) {
                    document.getElementById('‚è∞').innerHTML = '';
                    document.getElementById('üîÆ').innerHTML = '';
                    document.getElementById('üê¨').innerHTML = "A PORPOISE survey must have at least 2 options (üó≥1 & üó≥2)."
                    return 0;
                } else {
                    setOptions(options);
                    paddedSurveyLeafs = padArrayToPowerOfTwo(surveyLeafs, '0');
                    computeMerkleRoot(paddedSurveyLeafs).then((root) => {
                        console.log("Merkle Root: ", root);
                        surveyRoot = root;
                    })
                }
            } else {

                const message = "Not enough emojis for a PORPOISE-compatible survey.";
                document.getElementById('üê¨').innerHTML = message;
                console.log(message)
            }
            return 1;
        }

        // we need this function because there seem to be a lot of mobile browsers
        // that don't like URLSearchParams
        function parseQueryString(queryString) {

            if (!queryString) {
                return {};
            }

            // Split the query string into key-value pairs
            const queryParams = queryString.split('&');

            // Create an object to store the parsed parameters
            const params = {};

            // Iterate over each key-value pair and populate the object
            queryParams.forEach(param => {
                const [key, value] = param.split('=');
                params[decodeURIComponent(key)] = decodeURIComponent(value);
            });

            return params;
        }

        function generatePrediction() {
            // hash the prediction
            hashString(prediction).then((predictionHash) => {
                console.log("Prediction Hash: ", predictionHash);
                const predictionSalt = generateRandomString(18);
                console.log("Prediction Salt: ", predictionSalt);
                hashString(predictionSalt + predictionHash + surveyRoot).then((predictionCommitment) => {
                    document.getElementById("prediction").innerText = "Prediction Commitment: " + predictionCommitment + " Prediction Salt: " + predictionSalt;
                });
            })
        }

        function setOptions(optionsArray) {
            let optionsContainer = document.getElementById('üó≥')

            for (let i = 0; i < optionsArray.length; i++) {
                console.log("Option", i, ": ", optionsArray[i]);
                let paragraphElement = document.createElement('p');
                paragraphElement.innerText = 'üó≥' + (i + 1) + ". " + optionsArray[i].replace(/-/g, ' ');

                let inputElement = document.createElement('input');
                inputElement.setAttribute('type', 'radio');
                inputElement.setAttribute('name', 'options');
                inputElement.setAttribute('value', optionsArray[i]);
                inputElement.setAttribute('id', 'üó≥' + (i + 1) + 'input');
                paragraphElement.appendChild(inputElement);


                optionsContainer.appendChild(paragraphElement);
            }

            const radioButtons = document.querySelectorAll('input[type="radio"]');

            // Add event listener to each radio button
            radioButtons.forEach(button => {
                button.addEventListener('change', () => {
                    // Check which radio button is selected
                    if (button.checked) {
                        console.log('Selected option:', button.value);
                        prediction = button.value;
                    }
                });
            });
        }

        function convertUTCtoDate(utcTimestamp) {
            // Create a new Date object with the UTC timestamp
            // the UTC timestamp should be in miliseconds
            const date = new Date(parseInt(utcTimestamp, 10));

            // Get the individual components of the date and time
            const year = date.getUTCFullYear();
            const month = date.getUTCMonth() + 1; // Months are zero-indexed, so add 1
            const day = date.getUTCDate();
            const hours = date.getUTCHours();
            const minutes = date.getUTCMinutes();
            const seconds = date.getUTCSeconds();

            const formattedDateTime = `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;

            return formattedDateTime;
        }

        function generateRandomString(length) {
            const charset = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let randomString = '';

            for (let i = 0; i < length; i++) {
                const randomIndex = Math.floor(Math.random() * charset.length);
                randomString += charset[randomIndex];
            }

            return randomString;
        }

        function padArrayToPowerOfTwo(arr, paddingValue) {
            // Check if the array length is already a power of 2
            if ((arr.length & (arr.length - 1)) === 0) {
                return arr; // Array length is already a power of 2, no padding needed
            }

            // Calculate the next power of 2 greater than the current length
            const nextPowerOfTwo = Math.pow(2, Math.ceil(Math.log2(arr.length)));

            // Calculate the number of elements to pad
            const paddingCount = nextPowerOfTwo - arr.length;

            // Pad the array with the specified paddingValue (default is undefined)
            return arr.concat(new Array(paddingCount).fill(paddingValue));
        }

        // Function to compute the Merkle root hash from an array of strings
        async function computeMerkleRoot(strings) {
            if (strings.length === 0) {
                return null;
            }

            // Base case: if there's only one element, return its hash
            if (strings.length === 1) {
                return await hashString(strings[0]);
            }

            // Recursive case: compute hash of pairs until a single hash is obtained
            const pairedHashes = [];
            for (let i = 0; i < strings.length; i += 2) {
                const left = strings[i];
                const right = (i + 1 < strings.length) ? strings[i + 1] : '';
                const pairHash = await hashString(left + right);
                pairedHashes.push(pairHash);
            }

            // Recursively compute the Merkle root for the paired hashes
            return await computeMerkleRoot(pairedHashes);
        }

        // Function to hash a string (use any suitable hash function)
        function hashString(str) {
            const encoder = new TextEncoder();
            const data = encoder.encode(str);

            return crypto.subtle.digest('SHA-256', data).then(hashBuffer => {
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                return hashArray.map(byte => byte.toString(16).padStart(2, '0')).join('');
            });
        }
    </script>
</head>

<body onload="getSurveyComponents();">
    <header>
        <h1><a href="/">PORPOISE</a> Survey:</h1>
    </header>

    <h2 id="üê¨"></h2>

    <fieldset id="üó≥">
        <legend>Select an option:</legend>
    </fieldset>

    <div>
        <button class="button-28" onclick="generatePrediction()">Post Your Prediction!</button>
        <p id="prediction"></p>
    </div>

    <a href="https://twitter.com/intent/tweet?button_hashtag=PORPOISENetwork&ref_src=twsrc%5Etfw"
        class="twitter-hashtag-button" data-size="large" id="tweet-button"
        data-text="I made a prediction with PORPOISE: " data-related="zkporpoise" data-show-count="false">Tweet
        #PORPOISENetwork</a>
    <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

    <p id="‚è∞"></p>
    <p id="üîÆ"></p>

    <footer>
        <p>
            &copy; 2024 PORPOISE Network. All rights reserved.
        </p>
    </footer>
</body>

</html>